<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Dad Jokes - Files</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style_view.css" />
  </head>
  <body>
    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <div class="content">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <div class="card-box">
              <div class="row">
                <div class="col-lg-6 col-xl-6">
                  <h4 class="header-title m-b-30">Files</h4>
                </div>
              </div>
              <div class="container">
                <div class="row" id="file-container">
                  <!-- Dynamic content will be inserted here -->
                </div>
              </div>
              <!--                    <div class="text-center mt-3">-->
              <!--                        <button type="button" class="btn btn-outline-danger w-md waves-effect waves-light"><i class="mdi mdi-refresh"></i> Upload Files</button>-->
              <!--                    </div>-->
              <div class="text-center mt-3">
                <form>
                  <input
                    class="btn btn-outline-danger w-md waves-effect waves-light"
                    type="file"
                    id="myfile"
                    name="myfile"
                    multiple
                  /><br /><br />
                  <button
                    type="submit"
                    class="btn btn-outline-danger w-md waves-effect waves-light"
                  >
                    <i class="mdi mdi-refresh"></i> Upload Files
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
      const downloadFile = async (
        token,
        filename,
        publickey,
        iv,
        authTag,
        sharedText
      ) => {
        const response = await fetch(`/downloadfile/${filename}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        const blob = await response.blob();

        const url = window.URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const deleteFile = async (token, filename) => {
        const response = await fetch(`/delete/${filename}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
      };

      document.addEventListener("DOMContentLoaded", async () => {
        // need to get each parameter on request
        const token = sessionStorage.getItem(`token ${123456789}`);
        const response = await fetch("/allfiles", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        const data = await response.json();
        const files = data.files;
        console.log(files);
        const container = document.getElementById("file-container");

        files.forEach((file) => {
          const listItem = document.createElement("li");
          console.log(file);
          listItem.className =
            "list-group-item d-flex justify-content-between align-items-center";

          listItem.innerHTML = `
                <span>${file.filename}</span>
                <button onclick="downloadFile('${token}', '${file.filename}', '${file.publickey}', '${file.iv}', '${file.authTag}', '${file.sharedText}')"class="btn btn-outline-primary" >
                    <i class="fa fa-download"></i> Download
                </button>
                <button onclick="deleteFile('${token}', '${file.filename}')">Delete File</button>
            `;

          container.appendChild(listItem);
        });
      });
    </script>
  </body>
</html>
